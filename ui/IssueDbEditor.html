<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Silo Issues DB Editor</title>
    <style>
      :root {
        /* Light theme (default) */
        --bg: #f5f7fb;
        --bg2: #eef2f7;
        --panel: #ffffff;
        --panel-2: #f6f8fb;
        --text: #0d1117;
        --muted: #5b6b7c;
        --brand: #2a5ad1;
        --brand-2: #356fe7;
        --danger: #d83a3a;
        --ok: #1ea86b;
        --warn: #c37a08;
        --border: #dbe3ef;
        --hover-border: #c5d2e6;
        --shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        --radius: 12px;
        --toolbar-bg: rgba(255,255,255,0.65);
        --btn: #edf2f8; /* start */
        --btn-2: #e6ecf5; /* end */
        --btn-secondary: #eef2f7;
        --btn-secondary-2: #e4e9f3;
        --btn-primary: #356fe7;
        --btn-primary-2: #2a5ad1;
        --btn-danger: #e55;
        --btn-danger-2: #c33;
        --pill-bg: #f5f8fc;
        --card: #ffffff;
        --card-2: #f6f8fb;
        --footer-bg: #f4f7fb;
      }

      /* Dark theme overrides */
      .theme-dark {
        --bg: #0b0d10;
        --bg2: #0e1216;
        --panel: #131922;
        --panel-2: #0f141a;
        --text: #e7edf3;
        --muted: #95a3b3;
        --brand: #4f8cff;
        --brand-2: #7aa7ff;
        --danger: #f05454;
        --ok: #2ecc71;
        --warn: #f2b84b;
        --border: #243041;
        --hover-border: #2e4057;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        --toolbar-bg: rgba(16, 20, 26, 0.75);
        --btn: #1a2230;
        --btn-2: #15202b;
        --btn-secondary: #1a2029;
        --btn-secondary-2: #0f141a;
        --btn-primary: #356fe7;
        --btn-primary-2: #2a5ad1;
        --btn-danger: #e55;
        --btn-danger-2: #c33;
        --pill-bg: #10151b;
        --card: #151c26;
        --card-2: #10151c;
        --footer-bg: #0d1217;
      }

      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        background: linear-gradient(180deg, var(--bg) 0%, var(--bg) 60%, var(--bg2) 100%);
        color: var(--text);
        font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .toolbar {
        position: sticky;
        top: 0;
        z-index: 10;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 14px 16px;
        background: var(--toolbar-bg);
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border);
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-right: 12px;
      }
      .brand .logo {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        background: radial-gradient(72% 72% at 28% 28%, var(--brand) 0%, var(--brand-2) 60%, #2b62d6 100%);
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06), 0 6px 16px rgba(79, 140, 255, 0.25);
      }
      .brand .title {
        font-weight: 650;
        letter-spacing: 0.2px;
      }

      .toolbar .spacer { flex: 1; }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        background: linear-gradient(180deg, var(--btn) 0%, var(--btn-2) 100%);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 10px;
        box-shadow: var(--shadow);
        cursor: pointer;
        transition: transform 0.04s ease, border-color 0.2s ease, background 0.2s ease;
        user-select: none;
      }
      .btn:hover { border-color: var(--hover-border); }
      .btn:active { transform: translateY(1px); }
      .btn.primary {
        background: linear-gradient(180deg, var(--btn-primary) 0%, var(--btn-primary-2) 100%);
        border-color: var(--btn-primary-2);
      }
      .btn.destructive {
        background: linear-gradient(180deg, var(--btn-danger) 0%, var(--btn-danger-2) 100%);
        border-color: var(--btn-danger-2);
      }
      .btn.secondary {
        background: linear-gradient(180deg, var(--btn-secondary) 0%, var(--btn-secondary-2) 100%);
      }
      .btn:disabled { opacity: 0.5; cursor: not-allowed; }

      .hint {
        color: var(--muted);
        font-size: 12px;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        padding: 6px 10px;
        border: 1px solid var(--border);
        border-radius: 999px;
        background: var(--pill-bg);
      }
      .pill.warn { border-color: #5a4421; background: #1a1510; color: #ffd493; }
      .pill.ok { border-color: #1f5135; background: #0f1a14; color: #b6ffd1; }
      .pill.bad { border-color: #5a2121; background: #1a1010; color: #ffc2be; }

      .app {
        height: calc(100% - 58px);
        display: grid;
        grid-template-columns: 360px 1fr;
        gap: 16px;
        padding: 16px;
      }
      .panel {
        height: 100%;
        background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .left {
        display: flex;
        flex-direction: column;
      }
      .left .search {
        padding: 12px;
        border-bottom: 1px solid var(--border);
        display: grid;
        grid-template-columns: 1fr 120px;
        gap: 8px;
      }
      .input, select {
        background: #0e141b;
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
        outline: none;
        width: 100%;
        box-sizing: border-box;
      }
      .left .list {
        padding: 6px 8px 10px 8px;
        overflow: auto;
      }
      .card {
        border: 1px solid var(--border);
        border-radius: 12px;
        background: linear-gradient(180deg, var(--card) 0%, var(--card-2) 100%);
        padding: 10px 12px;
        margin: 8px 4px;
        cursor: pointer;
        transition: border-color 0.2s ease, background 0.2s ease;
      }
      .card:hover { border-color: var(--hover-border); }
      .card.active { border-color: var(--brand); box-shadow: 0 0 0 1px rgba(79,140,255,0.35) inset; }
      .card .id { font-weight: 650; color: var(--brand-2); }
      .card .desc { color: var(--muted); font-size: 13px; margin-top: 4px; }
      .card .meta { color: #aac6ff; font-size: 12px; margin-top: 6px; }

      .right {
        display: grid;
        grid-template-rows: auto 1fr auto;
      }
      .right .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 12px;
        border-bottom: 1px solid var(--border);
      }
      .right .content {
        overflow: auto;
        padding: 16px;
      }
      .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .field { margin-bottom: 12px; }
      .label { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
      textarea.input { min-height: 80px; resize: vertical; }
      textarea.input.small { min-height: 56px; }
      .row { display: flex; gap: 8px; align-items: center; }
      .steps .step-item { display: grid; grid-template-columns: 48px 1fr auto; gap: 8px; margin-bottom: 8px; align-items: center; }
      .steps .step-num { text-align: center; color: var(--muted); font-weight: 600; }
      .chips { display: flex; flex-wrap: wrap; gap: 6px; }
      .chip { background: #0f141a; border: 1px solid var(--border); padding: 4px 8px; border-radius: 999px; font-size: 12px; }

      .footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        border-top: 1px solid var(--border);
        background: var(--footer-bg);
      }
      .hidden { display: none; }
      .error { color: #ffb8b8; font-size: 12px; }

      @media (max-width: 1100px) {
        .app { grid-template-columns: 1fr; height: auto; }
        .right { min-height: 70vh; }
      }
    </style>
  </head>
  <body>
    <div class="toolbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">Silo Issues DB Editor</div>
      </div>

      <button class="btn" id="btnOpen" title="Open JSON file"><span>Open</span></button>
      <button class="btn primary" id="btnSave" title="Save to the same file" disabled><span>Save</span></button>
      <button class="btn" id="btnSaveAs" title="Save As… (choose a new file)"><span>Save As…</span></button>
      <button class="btn" id="btnExport" title="Download a copy"><span>Export</span></button>
      <button class="btn" id="btnCopy" title="Copy JSON to clipboard"><span>Copy</span></button>
      <button class="btn secondary" id="btnNew" title="Create new empty DB"><span>New</span></button>

      <div class="spacer"></div>

      <button class="btn" id="btnTheme" title="Toggle light/dark"><span>Light</span></button>
      <div id="envStatus" class="pill warn hidden">Limited mode: use Chrome/Edge to Save in-place</div>
      <div id="fileStatus" class="pill">No file opened</div>
      <div id="dirtyStatus" class="pill bad hidden">Unsaved changes</div>

      <input type="file" id="fileInput" accept="application/json" class="hidden" />
    </div>

    <div class="app">
      <div class="panel left">
        <div class="search">
          <input class="input" id="searchInput" placeholder="Search issues…" />
          <select id="categoryFilter">
            <option value="">All categories</option>
          </select>
        </div>
        <div class="list" id="issuesList"></div>
      </div>

      <div class="panel right">
        <div class="header">
          <div class="row">
            <button class="btn" id="btnAdd">Add</button>
            <button class="btn" id="btnDuplicate" disabled>Duplicate</button>
            <button class="btn destructive" id="btnDelete" disabled>Delete</button>
          </div>
          <div class="hint" id="selectionHint">Select an issue to edit</div>
        </div>
        <div class="content" id="editor">
          <div class="grid2">
            <div class="field">
              <div class="label">Issue ID</div>
              <input class="input" id="f_issue_id" readonly />
            </div>
            <div class="field">
              <div class="label">Category</div>
              <input class="input" id="f_category" placeholder="e.g., Device & Hardware" />
              <div class="error" id="e_category"></div>
            </div>
          </div>

          <div class="field">
            <div class="label">Short description</div>
            <textarea class="input" id="f_short_description" placeholder="One-sentence summary"></textarea>
            <div class="error" id="e_short_description"></div>
          </div>

          <div class="grid2">
            <div class="field">
              <div class="label">Keywords (comma separated)</div>
              <textarea class="input small" id="f_keywords" placeholder="keyword1, keyword2"></textarea>
            </div>
            <div class="field">
              <div class="label">Tickets (comma separated IDs)</div>
              <textarea class="input small" id="f_tickets" placeholder="20, 21, 35"></textarea>
            </div>
          </div>

          <div class="field">
            <div class="label">Root cause</div>
            <textarea class="input" id="f_root_cause"></textarea>
          </div>

          <div class="field steps">
            <div class="label">Resolution steps</div>
            <div id="stepsContainer"></div>
            <button class="btn" id="btnAddStep" style="margin-top:8px;">Add step</button>
            <div class="error" id="e_resolution_steps"></div>
          </div>

          <div class="grid2">
            <div class="field">
              <div class="label">Confidence (0.0 - 1.0)</div>
              <input class="input" id="f_confidence" type="number" min="0" max="1" step="0.01" />
            </div>
            <div class="field">
              <div class="label">Notes</div>
              <textarea class="input" id="f_notes"></textarea>
            </div>
          </div>
          <div class="error" id="e_global"></div>
        </div>
        <div class="footer">
          <div class="hint">Changes are local; use Save to write back to the same file.</div>
          <div class="row">
            <div class="pill ok hidden" id="saveOk">Saved</div>
            <div class="pill bad hidden" id="saveErr">Save failed</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Application state
      /** @type {Array<any>} */
      let db = [];
      /** @type {FileSystemFileHandle|null} */
      let currentFileHandle = null;
      let selectedIndex = -1;
      let dirty = false;

      // Elements
      const el = (id) => document.getElementById(id);
      const issuesList = el('issuesList');
      const searchInput = el('searchInput');
      const categoryFilter = el('categoryFilter');
      const fileStatus = el('fileStatus');
      const envStatus = el('envStatus');
      const dirtyStatus = el('dirtyStatus');
      const selectionHint = el('selectionHint');
      const fileInput = el('fileInput');

      // Editor fields
      const f_issue_id = el('f_issue_id');
      const f_category = el('f_category');
      const f_short_description = el('f_short_description');
      const f_keywords = el('f_keywords');
      const f_tickets = el('f_tickets');
      const f_root_cause = el('f_root_cause');
      const f_confidence = el('f_confidence');
      const f_notes = el('f_notes');
      const stepsContainer = el('stepsContainer');

      const e_category = el('e_category');
      const e_short_description = el('e_short_description');
      const e_resolution_steps = el('e_resolution_steps');
      const e_global = el('e_global');

      const btnOpen = el('btnOpen');
      const btnSave = el('btnSave');
      const btnSaveAs = el('btnSaveAs');
      const btnExport = el('btnExport');
      const btnCopy = el('btnCopy');
      const btnNew = el('btnNew');
      const btnTheme = el('btnTheme');
      const btnAdd = el('btnAdd');
      const btnDuplicate = el('btnDuplicate');
      const btnDelete = el('btnDelete');
      const btnAddStep = el('btnAddStep');

      const saveOk = el('saveOk');
      const saveErr = el('saveErr');

      const supportsFS = 'showOpenFilePicker' in window && 'showSaveFilePicker' in window;

      function setDirty(v) {
        dirty = !!v;
        dirtyStatus.classList.toggle('hidden', !dirty);
      }

      function showToast(node) {
        node.classList.remove('hidden');
        setTimeout(() => node.classList.add('hidden'), 1400);
      }

      function serializeDb() {
        return JSON.stringify(db, null, 2) + '\n';
      }

      function refreshCategoryOptions() {
        const cats = Array.from(new Set(db.map(x => x.category).filter(Boolean))).sort((a,b) => a.localeCompare(b));
        const current = categoryFilter.value;
        categoryFilter.innerHTML = '<option value="">All categories</option>' + cats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
        categoryFilter.value = current || '';
      }

      function escapeHtml(str) {
        return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
      }

      function renderList() {
        const q = searchInput.value.trim().toLowerCase();
        const cat = categoryFilter.value;
        const items = db
          .map((x, i) => ({ x, i }))
          .filter(({ x }) => !cat || x.category === cat)
          .filter(({ x }) => {
            if (!q) return true;
            const t = [x.issue_id, x.category, x.short_description, x.notes, ...(x.keywords||[]), ...(x.resolution_steps||[])].join(' ').toLowerCase();
            return t.includes(q);
          })
          .sort((a, b) => a.x.issue_id.localeCompare(b.x.issue_id));

        issuesList.innerHTML = items.map(({ x, i }) => `
          <div class="card ${i === selectedIndex ? 'active' : ''}" data-index="${i}">
            <div class="id">${escapeHtml(x.issue_id || '(new)')}</div>
            <div class="desc">${escapeHtml(x.short_description || '')}</div>
            <div class="meta">${escapeHtml(x.category || '')}</div>
          </div>
        `).join('');

        issuesList.querySelectorAll('.card').forEach(card => {
          card.addEventListener('click', () => {
            const i = Number(card.getAttribute('data-index'));
            selectIssue(i);
          });
        });

        refreshCategoryOptions();
      }

      function selectIssue(i) {
        selectedIndex = i;
        renderList();
        const issue = db[i];
        if (!issue) {
          clearEditor();
          btnDuplicate.disabled = true;
          btnDelete.disabled = true;
          selectionHint.textContent = 'Select an issue to edit';
          return;
        }
        selectionHint.textContent = issue.issue_id;
        btnDuplicate.disabled = false;
        btnDelete.disabled = false;
        bindEditor(issue);
      }

      function clearEditor() {
        f_issue_id.value = '';
        f_category.value = '';
        f_short_description.value = '';
        f_keywords.value = '';
        f_tickets.value = '';
        f_root_cause.value = '';
        f_confidence.value = '';
        f_notes.value = '';
        stepsContainer.innerHTML = '';
        [e_category, e_short_description, e_resolution_steps, e_global].forEach(n => n.textContent = '');
      }

      function bindEditor(issue) {
        f_issue_id.value = issue.issue_id || '';
        f_category.value = issue.category || '';
        f_short_description.value = issue.short_description || '';
        f_keywords.value = (issue.keywords || []).join(', ');
        f_tickets.value = (issue.tickets || []).join(', ');
        f_root_cause.value = issue.root_cause || '';
        f_confidence.value = (typeof issue.confidence === 'number' ? issue.confidence : '').toString();
        f_notes.value = issue.notes || '';

        stepsContainer.innerHTML = '';
        (issue.resolution_steps || []).forEach((s, idx) => addStepRow(s, idx));
        renumberSteps();
      }

      function addStepRow(text = '', index = null) {
        const row = document.createElement('div');
        row.className = 'step-item';
        row.innerHTML = `
          <div class="step-num"></div>
          <input class="input step-input" value="${escapeHtml(stripStepNumber(text))}" />
          <div class="row">
            <button class="btn" title="Move up">↑</button>
            <button class="btn" title="Move down">↓</button>
            <button class="btn destructive" title="Remove">✕</button>
          </div>
        `;
        const [upBtn, downBtn, delBtn] = row.querySelectorAll('button');
        upBtn.addEventListener('click', () => moveStep(row, -1));
        downBtn.addEventListener('click', () => moveStep(row, +1));
        delBtn.addEventListener('click', () => { row.remove(); markDirtyFromEditor(); renumberSteps(); });
        stepsContainer.appendChild(row);
        if (index !== null) stepsContainer.insertBefore(row, stepsContainer.children[index] || null);
        renumberSteps();
      }

      function moveStep(row, delta) {
        const parent = stepsContainer;
        const idx = Array.from(parent.children).indexOf(row);
        const newIdx = idx + delta;
        if (newIdx < 0 || newIdx >= parent.children.length) return;
        parent.insertBefore(row, parent.children[delta > 0 ? newIdx + 1 : newIdx]);
        markDirtyFromEditor();
        renumberSteps();
      }

      function renumberSteps() {
        const rows = Array.from(stepsContainer.children);
        rows.forEach((row, i) => {
          const num = row.querySelector('.step-num');
          const upBtn = row.querySelector('button[title="Move up"]');
          const downBtn = row.querySelector('button[title="Move down"]');
          if (num) num.textContent = String(i + 1) + '.';
          if (upBtn) upBtn.disabled = i === 0;
          if (downBtn) downBtn.disabled = i === rows.length - 1;
        });
      }

      function stripStepNumber(text) {
        return String(text).replace(/^\s*\d+[\.)]\s*/, '');
      }

      function collectEditor() {
        const keywords = f_keywords.value.split(',').map(s => s.trim()).filter(Boolean);
        const tickets = f_tickets.value.split(',').map(s => s.trim()).filter(Boolean).map(s => Number(s)).filter(n => Number.isInteger(n));
        const steps = Array.from(stepsContainer.querySelectorAll('.step-input'))
          .map(i => i.value.trim())
          .filter(Boolean)
          .map((val, idx) => `${idx + 1}. ${val}`);
        return {
          issue_id: f_issue_id.value.trim(),
          category: f_category.value.trim(),
          short_description: f_short_description.value.trim(),
          keywords,
          root_cause: f_root_cause.value.trim(),
          resolution_steps: steps,
          confidence: f_confidence.value === '' ? null : clamp(parseFloat(f_confidence.value), 0, 1),
          notes: f_notes.value.trim(),
          tickets
        };
      }

      function clamp(x, a, b) { return Math.max(a, Math.min(b, x)); }

      function validateIssue(issue) {
        const errs = {};
        if (!issue.category) errs.category = 'Category is required';
        if (!issue.short_description) errs.short_description = 'Short description is required';
        if (!Array.isArray(issue.resolution_steps) || issue.resolution_steps.length === 0) errs.resolution_steps = 'At least one resolution step is required';
        if (issue.confidence !== null && (isNaN(issue.confidence) || issue.confidence < 0 || issue.confidence > 1)) errs.confidence = 'Confidence must be between 0 and 1';
        return errs;
      }

      function validateDb() {
        const seen = new Set();
        const errors = [];
        for (let i = 0; i < db.length; i++) {
          const it = db[i];
          const e = validateIssue(it);
          if (Object.keys(e).length) errors.push({ index: i, id: it.issue_id, errors: e });
          if (!it.issue_id) {
            errors.push({ index: i, id: it.issue_id, errors: { issue_id: 'Missing issue_id' } });
          } else if (seen.has(it.issue_id)) {
            errors.push({ index: i, id: it.issue_id, errors: { issue_id: 'Duplicate issue_id' } });
          } else {
            seen.add(it.issue_id);
          }
        }
        return { ok: errors.length === 0, errors };
      }

      function applyEditorToSelected() {
        if (selectedIndex < 0 || !db[selectedIndex]) return;
        const updated = collectEditor();
        const errs = validateIssue(updated);
        e_category.textContent = errs.category || '';
        e_short_description.textContent = errs.short_description || '';
        e_resolution_steps.textContent = errs.resolution_steps || '';
        if (Object.keys(errs).length) {
          // keep fields but don't overwrite DB if invalid
          return;
        }
        db[selectedIndex] = { ...db[selectedIndex], ...updated };
        setDirty(true);
        renderList();
      }

      function markDirtyFromEditor() {
        if (selectedIndex < 0) return;
        setDirty(true);
      }

      function nextIssueId() {
        const nums = db.map(x => String(x.issue_id || '').match(/^ISSUE-(\d{4})$/)?.[1]).filter(Boolean).map(s => parseInt(s, 10));
        const max = nums.length ? Math.max(...nums) : 0;
        const n = max + 1;
        return `ISSUE-${String(n).padStart(4, '0')}`;
      }

      function addIssue() {
        const id = nextIssueId();
        const newIssue = {
          issue_id: id,
          category: '',
          short_description: '',
          keywords: [],
          root_cause: '',
          resolution_steps: [''],
          confidence: 1.0,
          notes: '',
          tickets: []
        };
        db.push(newIssue);
        setDirty(true);
        renderList();
        selectIssue(db.length - 1);
      }

      function duplicateIssue() {
        if (selectedIndex < 0) return;
        const src = db[selectedIndex];
        const copy = JSON.parse(JSON.stringify(src));
        copy.issue_id = nextIssueId();
        db.push(copy);
        setDirty(true);
        renderList();
        selectIssue(db.length - 1);
      }

      function deleteIssue() {
        if (selectedIndex < 0) return;
        const id = db[selectedIndex].issue_id;
        if (!confirm(`Delete ${id}?`)) return;
        db.splice(selectedIndex, 1);
        selectedIndex = -1;
        setDirty(true);
        renderList();
        clearEditor();
      }

      async function openFileFS() {
        const [handle] = await window.showOpenFilePicker({
          types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }],
          excludeAcceptAllOption: false,
          multiple: false
        });
        currentFileHandle = handle;
        const file = await handle.getFile();
        const text = await file.text();
        loadJsonText(text);
        fileStatus.textContent = file.name;
        btnSave.disabled = false;
      }

      async function saveFileFS() {
        if (!currentFileHandle) return;
        const { ok, errors } = validateDb();
        if (!ok) {
          e_global.textContent = `Cannot save: ${errors.length} invalid entr${errors.length === 1 ? 'y' : 'ies'}.`;
          showToast(saveErr);
          return;
        }
        e_global.textContent = '';
        const writable = await currentFileHandle.createWritable();
        await writable.write(serializeDb());
        await writable.close();
        setDirty(false);
        showToast(saveOk);
      }

      async function saveAsFS() {
        if (!supportsFS) return exportDownload();
        const handle = await window.showSaveFilePicker({
          suggestedName: currentFileHandle ? (await currentFileHandle.getFile()).name : 'silo_issues_db.json',
          types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }]
        });
        const writable = await handle.createWritable();
        await writable.write(serializeDb());
        await writable.close();
        currentFileHandle = handle;
        fileStatus.textContent = (await handle.getFile()).name;
        btnSave.disabled = false;
        setDirty(false);
        showToast(saveOk);
      }

      function exportDownload() {
        const blob = new Blob([serializeDb()], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'silo_issues_db.json';
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(a.href);
        a.remove();
      }

      async function copyJson() {
        const text = serializeDb();
        try {
          await navigator.clipboard.writeText(text);
          showToast(saveOk);
        } catch (e) {
          alert('Clipboard permission denied.');
        }
      }

      function importViaInput() {
        fileInput.onchange = async () => {
          const file = fileInput.files && fileInput.files[0];
          if (!file) return;
          const text = await file.text();
          loadJsonText(text);
          fileStatus.textContent = file.name;
          currentFileHandle = null; // unknown handle in fallback mode
          btnSave.disabled = !supportsFS; // only enable if FS available and we obtain handle later
          fileInput.value = '';
        };
        fileInput.click();
      }

      function loadJsonText(text) {
        try {
          const parsed = JSON.parse(text);
          if (!Array.isArray(parsed)) throw new Error('Expected a JSON array at top level');
          db = parsed;
          selectedIndex = -1;
          setDirty(false);
          e_global.textContent = '';
          renderList();
          clearEditor();
          if (db.length) selectIssue(0);
        } catch (e) {
          e_global.textContent = 'Invalid JSON: ' + e.message;
        }
      }

      function newDb() {
        if (dirty && !confirm('Discard unsaved changes and create new DB?')) return;
        db = [];
        selectedIndex = -1;
        setDirty(false);
        renderList();
        clearEditor();
        fileStatus.textContent = 'Untitled';
        currentFileHandle = null;
        btnSave.disabled = !supportsFS;
      }

      // Wire events
      btnOpen.addEventListener('click', async () => {
        if (supportsFS) {
          try { await openFileFS(); } catch (e) { if (e?.name !== 'AbortError') importViaInput(); }
        } else {
          importViaInput();
        }
      });
      btnSave.addEventListener('click', async () => { try { await saveFileFS(); } catch (e) { console.error(e); showToast(saveErr); } });
      btnSaveAs.addEventListener('click', async () => { try { await saveAsFS(); } catch (e) { if (e?.name !== 'AbortError') { console.error(e); showToast(saveErr); } } });
      btnExport.addEventListener('click', exportDownload);
      btnCopy.addEventListener('click', copyJson);
      btnNew.addEventListener('click', newDb);
      btnTheme.addEventListener('click', toggleTheme);
      btnAdd.addEventListener('click', addIssue);
      btnDuplicate.addEventListener('click', duplicateIssue);
      btnDelete.addEventListener('click', deleteIssue);
      btnAddStep.addEventListener('click', () => { addStepRow(''); markDirtyFromEditor(); });

      [f_category, f_short_description, f_keywords, f_tickets, f_root_cause, f_confidence, f_notes].forEach(input => {
        input.addEventListener('input', () => { applyEditorToSelected(); });
      });

      searchInput.addEventListener('input', renderList);
      categoryFilter.addEventListener('change', renderList);

      // Environment setup
      (function init() {
        // theme: light default, restore saved
        const savedTheme = localStorage.getItem('silo-theme');
        if (savedTheme === 'dark') {
          document.body.classList.add('theme-dark');
          btnTheme.querySelector('span').textContent = 'Dark';
        } else {
          document.body.classList.remove('theme-dark');
          btnTheme.querySelector('span').textContent = 'Light';
        }
        if (!supportsFS) envStatus.classList.remove('hidden');
        btnSave.disabled = true; // until a FS handle is acquired via Open or Save As
        renderList();
        clearEditor();
      })();

      function toggleTheme() {
        const isDark = document.body.classList.toggle('theme-dark');
        localStorage.setItem('silo-theme', isDark ? 'dark' : 'light');
        btnTheme.querySelector('span').textContent = isDark ? 'Dark' : 'Light';
      }
    </script>
  </body>
  </html>


