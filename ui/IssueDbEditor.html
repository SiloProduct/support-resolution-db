<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Silo Issues DB Editor</title>
    <style>
      :root {
        /* Light theme (default) */
        --bg: #f5f7fb;
        --bg2: #eef2f7;
        --panel: #ffffff;
        --panel-2: #f6f8fb;
        --text: #0d1117;
        --muted: #5b6b7c;
        --brand: #2a5ad1;
        --brand-2: #356fe7;
        --danger: #d83a3a;
        --ok: #1ea86b;
        --warn: #c37a08;
        --border: #dbe3ef;
        --hover-border: #c5d2e6;
        --shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        --radius: 12px;
        --toolbar-bg: rgba(255,255,255,0.65);
        --btn: #edf2f8; /* start */
        --btn-2: #e6ecf5; /* end */
        --btn-secondary: #eef2f7;
        --btn-secondary-2: #e4e9f3;
        --btn-primary: #a2c0fc;
        --btn-primary-2: #afc1ee;
        --btn-danger: #e59d9d;
        --btn-danger-2: #d28484;
        --pill-bg: #f5f8fc;
        --card: #ffffff;
        --card-2: #f6f8fb;
        --footer-bg: #f4f7fb;
        --input-bg: #ffffff;
        --input-border: #dbe3ef;
        --input-hover: #c5d2e6;
        --toolbar-height: 58px; /* will be measured on load */
      }

      /* Dark theme overrides */
      .theme-dark {
        --bg: #0b0d10;
        --bg2: #0e1216;
        --panel: #131922;
        --panel-2: #0f141a;
        --text: #e7edf3;
        --muted: #95a3b3;
        --brand: #4f8cff;
        --brand-2: #7aa7ff;
        --danger: #f05454;
        --ok: #2ecc71;
        --warn: #f2b84b;
        --border: #243041;
        --hover-border: #2e4057;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        --toolbar-bg: rgba(16, 20, 26, 0.75);
        --btn: #1a2230;
        --btn-2: #15202b;
        --btn-secondary: #1a2029;
        --btn-secondary-2: #0f141a;
        --btn-primary: #356fe7;
        --btn-primary-2: #2a5ad1;
        --btn-danger: #e55;
        --btn-danger-2: #c33;
        --pill-bg: #10151b;
        --card: #151c26;
        --card-2: #10151c;
        --footer-bg: #0d1217;
        --input-bg: #0e141b;
        --input-border: #243041;
        --input-hover: #2e4057;
      }

      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        background: linear-gradient(180deg, var(--bg) 0%, var(--bg) 60%, var(--bg2) 100%);
        color: var(--text);
        font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .toolbar {
        position: sticky;
        top: 0;
        z-index: 10;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 14px 16px;
        background: var(--toolbar-bg);
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border);
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-right: 12px;
      }
      .brand .logo {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        background: radial-gradient(72% 72% at 28% 28%, var(--brand) 0%, var(--brand-2) 60%, #2b62d6 100%);
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06), 0 6px 16px rgba(79, 140, 255, 0.25);
      }
      .brand .title {
        font-weight: 650;
        letter-spacing: 0.2px;
      }

      .toolbar .spacer { flex: 1; }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        background: linear-gradient(180deg, var(--btn) 0%, var(--btn-2) 100%);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 10px;
        box-shadow: var(--shadow);
        cursor: pointer;
        transition: transform 0.04s ease, border-color 0.2s ease, background 0.2s ease;
        user-select: none;
      }
      .btn:hover { border-color: var(--hover-border); }
      .btn:active { transform: translateY(1px); }
      .btn.primary {
        background: linear-gradient(180deg, var(--btn-primary) 0%, var(--btn-primary-2) 100%);
        border-color: var(--btn-primary-2);
      }
      .btn.destructive {
        background: linear-gradient(180deg, var(--btn-danger) 0%, var(--btn-danger-2) 100%);
        border-color: var(--btn-danger-2);
      }
      .btn.secondary {
        background: linear-gradient(180deg, var(--btn-secondary) 0%, var(--btn-secondary-2) 100%);
      }
      .btn:disabled { opacity: 0.5; cursor: not-allowed; }

      .hint {
        color: var(--muted);
        font-size: 12px;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        padding: 6px 10px;
        border: 1px solid var(--border);
        border-radius: 999px;
        background: var(--pill-bg);
      }
      .pill.warn { border-color: #5a4421; background: #1a1510; color: #ffd493; }
      .pill.ok { border-color: #1f5135; background: #0f1a14; color: #b6ffd1; }
      .pill.bad { border-color: #5a2121; background: #1a1010; color: #ffc2be; }

      .app {
        height: calc(100vh - var(--toolbar-height));
        box-sizing: border-box;
        overflow: hidden;
        display: grid;
        grid-template-columns: 360px 1fr;
        gap: 16px;
        padding: 16px;
      }
      .panel {
        height: 100%;
        background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .left { display: flex; flex-direction: column; min-height: 0; }
      .left .top-actions { padding: 8px 12px 0 12px; }
      .left .search {
        padding: 12px;
        border-bottom: 1px solid var(--border);
        display: grid;
        grid-template-columns: 1fr 120px auto;
        gap: 8px;
      }
      .input, select {
        background: var(--input-bg);
        color: var(--text);
        border: 1px solid var(--input-border);
        border-radius: 10px;
        padding: 10px 12px;
        outline: none;
        width: 100%;
        box-sizing: border-box;
        transition: border-color 0.2s ease;
      }
      .input:hover, select:hover {
        border-color: var(--input-hover);
      }
      .input:disabled { opacity: 0.7; cursor: not-allowed; }
      .left .list { padding: 6px 8px 10px 8px; overflow: auto; height: 100%; box-sizing: border-box; }
      .card {
        border: 1px solid var(--border);
        border-radius: 12px;
        background: linear-gradient(180deg, var(--card) 0%, var(--card-2) 100%);
        padding: 10px 12px;
        margin: 8px 4px;
        cursor: pointer;
        transition: border-color 0.2s ease, background 0.2s ease;
      }
      .card:hover { border-color: var(--hover-border); }
      .card.active { border-color: var(--brand); box-shadow: 0 0 0 1px rgba(79,140,255,0.35) inset; }
      .card .id { font-weight: 650; color: var(--brand-2); }
      .card .desc { color: var(--muted); font-size: 13px; margin-top: 4px; }
      .card .meta { color: #aac6ff; font-size: 12px; margin-top: 6px; }

      .right { display: grid; grid-template-rows: auto 1fr auto; min-height: 0; }
      .right .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 12px;
        border-bottom: 1px solid var(--border);
      }
      .nav-controls {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .nav-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        background: var(--btn-secondary);
        color: var(--text);
        border: 1px solid var(--input-border);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 16px;
        font-weight: 600;
      }
      .nav-btn:hover:not(:disabled) {
        background: var(--btn-secondary-2);
        border-color: var(--input-hover);
      }
      .nav-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .right .content { overflow: auto; padding: 16px; height: 100%; box-sizing: border-box; }
      .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .field { margin-bottom: 12px; }
      .label { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
      textarea.input { min-height: 80px; resize: vertical; }
      textarea.input.small { min-height: 56px; }
      .row { display: flex; gap: 8px; align-items: center; }
      .steps .step-item { display: grid; grid-template-columns: 48px 1fr auto; gap: 8px; margin-bottom: 8px; align-items: center; }
      .steps .step-num { text-align: center; color: var(--muted); font-weight: 600; }
      .chips { display: flex; flex-wrap: wrap; gap: 6px; }
      .chip { display: inline-flex; align-items: center; gap: 6px; background: var(--pill-bg); border: 1px solid var(--border); padding: 4px 8px; border-radius: 999px; font-size: 12px; }
      .chip .remove { appearance: none; border: none; background: transparent; color: var(--muted); cursor: pointer; padding: 0 2px; font-size: 14px; line-height: 1; }
      .chip .remove:hover { color: var(--danger); }
      .grow { flex: 1; }

      .footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        border-top: 1px solid var(--border);
        background: var(--footer-bg);
      }
      .hidden { display: none; }
      .error { color: #ffb8b8; font-size: 12px; }

      /* Conversation modal */
      .modal-backdrop {
        position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 100;
      }
      .modal {
        width: min(900px, 92vw);
        max-height: 80vh;
        background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: var(--shadow);
        display: grid; grid-template-rows: auto 1fr auto;
      }
      .modal .m-header { display:flex; align-items:center; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid var(--border); }
      .modal .m-title { font-weight: 600; }
      .modal .m-content { padding: 12px; overflow: auto; font-size: 14px; }
      .msg { border: 1px solid var(--border); border-radius: 10px; padding: 6px 8px; margin-bottom: 8px; }
      .msg.agent { background: rgba(79,140,255,0.08); }
      .msg.user { background: rgba(243, 156, 18, 0.08); }
      .modal .m-footer { padding: 10px 12px; border-top: 1px solid var(--border); display:flex; justify-content:flex-end; }
      .json-textarea { width: 100%; min-height: 50vh; background: var(--input-bg); color: var(--text); border: 1px solid var(--input-border); border-radius: 10px; padding: 10px 12px; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 13px; }

      @media (max-width: 1100px) {
        .app { grid-template-columns: 1fr; height: auto; }
        .right { min-height: 70vh; }
      }
    </style>
  </head>
  <body>
    <div class="toolbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">Silo Issues DB Editor</div>
      </div>

      <button class="btn" id="btnOpen" title="Open JSON file"><span>Open</span></button>
      <button class="btn primary" id="btnSave" title="Save to the same file" disabled><span>Save</span></button>
      <button class="btn" id="btnSaveAs" title="Save As… (choose a new file)"><span>Save As…</span></button>
      
      <button class="btn" id="btnCopy" title="Copy JSON to clipboard"><span>Copy</span></button>
      <button class="btn secondary" id="btnNew" title="Create new empty DB"><span>New</span></button>

      <div class="spacer"></div>

      <button class="btn" id="btnLinkConversations" title="Link conversations folder"><span>Link conversations</span></button>
      <button class="btn" id="btnTheme" title="Toggle light/dark"><span>Light</span></button>
      <div id="envStatus" class="pill warn hidden">Limited mode: use Chrome/Edge to Save in-place</div>
      <div id="fileStatus" class="pill">No file opened</div>
      <div id="dirtyStatus" class="pill bad hidden">Unsaved changes</div>

      <input type="file" id="fileInput" accept="application/json" class="hidden" />
    </div>

    <div class="app">
      <div class="panel left">
        <div class="top-actions">
          <button class="btn secondary" id="btnReassignIds" title="Reassign issue IDs sequentially" style="padding:6px 10px; font-size:12px;">Reassign IDs</button>
        </div>
        <div class="search">
          <input class="input" id="searchInput" placeholder="Search issues…" />
          <select id="categoryFilter">
            <option value="">All categories</option>
          </select>
          <button class="btn" id="searchClear" title="Clear" style="padding:6px 10px;">Clear</button>
        </div>
        <div class="list" id="issuesList"></div>
      </div>

      <div class="panel right">
        <div class="header">
          <div class="row">
            <button class="btn" id="btnAdd">Add</button>
            <button class="btn" id="btnDuplicate" disabled>Duplicate</button>
            <button class="btn destructive" id="btnDelete" disabled>Delete</button>
            <button class="btn" id="btnEditJson" title="Edit issue as JSON">Edit JSON</button>
          </div>
          <div class="nav-controls">
            <button class="nav-btn" id="btnPrev" disabled title="Previous issue">←</button>
            <div class="hint" id="selectionHint">Select an issue to edit</div>
            <button class="nav-btn" id="btnNext" disabled title="Next issue">→</button>
          </div>
        </div>
        <div class="content" id="editor">
          <div class="grid2">
            <div class="field">
              <div class="label">Issue ID</div>
              <input class="input" id="f_issue_id" readonly disabled />
            </div>
            <div class="field">
              <div class="label">Category</div>
              <input class="input" id="f_category" placeholder="e.g., Device & Hardware" />
              <div class="error" id="e_category"></div>
            </div>
          </div>

          <div class="field">
            <div class="label">Short description</div>
            <textarea class="input" id="f_short_description" placeholder="One-sentence summary"></textarea>
            <div class="error" id="e_short_description"></div>
          </div>

          <div class="grid2">
            <div class="field">
              <div class="label">Keywords</div>
              <div class="chips" id="keywordsChips"></div>
              <div class="row" style="margin-top:8px;">
                <input class="input grow" id="kwInput" placeholder="Add keyword and press Enter" />
                <button class="btn" id="kwAdd">Add</button>
              </div>
            </div>
            <div class="field">
              <div class="label">Tickets</div>
              <div class="chips" id="ticketsChips"></div>
              <div class="row" style="margin-top:8px;">
                <input class="input grow" id="tkInput" placeholder="Add ticket id (number) and press Enter" />
                <button class="btn" id="tkAdd">Add</button>
              </div>
            </div>
          </div>

          <div class="field">
            <div class="label">Root cause</div>
            <textarea class="input" id="f_root_cause"></textarea>
          </div>

          <div class="field steps">
            <div class="label">Resolution steps</div>
            <div id="stepsContainer"></div>
            <button class="btn" id="btnAddStep" style="margin-top:8px;">Add step</button>
            <div class="error" id="e_resolution_steps"></div>
          </div>

          <div class="grid2">
            <div class="field">
              <div class="label">Notes</div>
              <textarea class="input" id="f_notes"></textarea>
            </div>
            <div class="field">
              <div class="label">Confidence</div>
              <div class="pill" id="f_confidence_label">—</div>
            </div>
          </div>
          <div class="error" id="e_global"></div>
        </div>
        <div class="footer">
          <div class="hint">Changes are local; use Save to write back to the same file.</div>
          <div class="row">
            <div class="pill ok hidden" id="saveOk">Saved</div>
            <div class="pill bad hidden" id="saveErr">Save failed</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Conversation Modal -->
    <div class="modal-backdrop" id="convBackdrop">
      <div class="modal">
        <div class="m-header">
          <div class="m-title" id="convTitle">Conversation</div>
        </div>
        <div class="m-content" id="convContent"></div>
        <div class="m-footer">
          <button class="btn" id="convFreshdesk">View in Freshdesk</button>
          <button class="btn" id="convClose2">Close</button>
        </div>
      </div>
    </div>

    <!-- JSON Editor Modal -->
    <div class="modal-backdrop" id="jsonBackdrop">
      <div class="modal">
        <div class="m-header">
          <div class="m-title">Edit Issue JSON</div>
        </div>
        <div class="m-content">
          <textarea class="json-textarea" id="jsonTextarea"></textarea>
          <div class="error" id="jsonError" style="margin-top:8px;"></div>
        </div>
        <div class="m-footer">
          <button class="btn" id="jsonCancel">Cancel</button>
          <button class="btn primary" id="jsonSave">Save</button>
        </div>
      </div>
    </div>

    <script>
      // Application state
      /** @type {Array<any>} */
      let db = [];
      /** @type {FileSystemFileHandle|null} */
      let currentFileHandle = null;
      /** @type {FileSystemDirectoryHandle|null} */
      let conversationsDirHandle = null;
      let selectedIndex = -1;
      let dirty = false;

      // Elements
      const el = (id) => document.getElementById(id);
      const issuesList = el('issuesList');
      const searchInput = el('searchInput');
      const categoryFilter = el('categoryFilter');
      const fileStatus = el('fileStatus');
      const envStatus = el('envStatus');
      const dirtyStatus = el('dirtyStatus');
      const selectionHint = el('selectionHint');
      const fileInput = el('fileInput');

      // Editor fields
      const f_issue_id = el('f_issue_id');
      const f_category = el('f_category');
      const f_short_description = el('f_short_description');
      const keywordsChips = el('keywordsChips');
      const kwInput = el('kwInput');
      const kwAdd = el('kwAdd');
      const ticketsChips = el('ticketsChips');
      const tkInput = el('tkInput');
      const tkAdd = el('tkAdd');
      const btnLinkConversations = el('btnLinkConversations');
      const f_root_cause = el('f_root_cause');
      const f_confidence_label = el('f_confidence_label');
      const f_notes = el('f_notes');
      const stepsContainer = el('stepsContainer');

      const e_category = el('e_category');
      const e_short_description = el('e_short_description');
      const e_resolution_steps = el('e_resolution_steps');
      const e_global = el('e_global');

      const btnOpen = el('btnOpen');
      const btnSave = el('btnSave');
      const btnSaveAs = el('btnSaveAs');
      
      const btnCopy = el('btnCopy');
      const btnNew = el('btnNew');
      const btnTheme = el('btnTheme');
      const btnAdd = el('btnAdd');
      const btnDuplicate = el('btnDuplicate');
      const btnDelete = el('btnDelete');
      const btnAddStep = el('btnAddStep');
      const btnPrev = el('btnPrev');
      const btnNext = el('btnNext');
      const btnEditJson = el('btnEditJson');

      const saveOk = el('saveOk');
      const saveErr = el('saveErr');
      const convBackdrop = el('convBackdrop');
      const convTitle = el('convTitle');
      const convContent = el('convContent');
      const convClose2 = el('convClose2');
      const convFreshdesk = el('convFreshdesk');
      const jsonBackdrop = el('jsonBackdrop');
      const jsonTextarea = el('jsonTextarea');
      const jsonError = el('jsonError');
      const jsonCancel = el('jsonCancel');
      const jsonSave = el('jsonSave');
      const btnReassignIds = el('btnReassignIds');

      const supportsFS = 'showOpenFilePicker' in window && 'showSaveFilePicker' in window;
      const supportsDirPicker = 'showDirectoryPicker' in window;

      function setDirty(v) {
        dirty = !!v;
        dirtyStatus.classList.toggle('hidden', !dirty);
      }

      function showToast(node) {
        node.classList.remove('hidden');
        setTimeout(() => node.classList.add('hidden'), 1400);
      }

      function serializeDb() {
        return JSON.stringify(db, null, 2) + '\n';
      }

      function refreshCategoryOptions() {
        const cats = Array.from(new Set(db.map(x => x.category).filter(Boolean))).sort((a,b) => a.localeCompare(b));
        const current = categoryFilter.value;
        categoryFilter.innerHTML = '<option value="">All categories</option>' + cats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
        categoryFilter.value = current || '';
      }

      function escapeHtml(str) {
        return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
      }

      function renderList() {
        const q = searchInput.value.trim().toLowerCase();
        const cat = categoryFilter.value;
        const items = db
          .map((x, i) => ({ x, i }))
          .filter(({ x }) => !cat || x.category === cat)
          .filter(({ x }) => {
            if (!q) return true;
            const t = [x.issue_id, x.category, x.short_description, x.notes, ...(x.keywords||[]), ...(x.resolution_steps||[])].join(' ').toLowerCase();
            return t.includes(q);
          })
          .sort((a, b) => a.x.issue_id.localeCompare(b.x.issue_id));

        issuesList.innerHTML = items.map(({ x, i }) => `
          <div class="card ${i === selectedIndex ? 'active' : ''}" data-index="${i}">
            <div class="id">${escapeHtml(x.issue_id || '(new)')}</div>
            <div class="desc">${escapeHtml(x.short_description || '')}</div>
            <div class="meta">${escapeHtml(x.category || '')}</div>
          </div>
        `).join('');

        issuesList.querySelectorAll('.card').forEach(card => {
          card.addEventListener('click', () => {
            const i = Number(card.getAttribute('data-index'));
            selectIssue(i);
          });
        });

        refreshCategoryOptions();
      }

      function selectIssue(i) {
        selectedIndex = i;
        renderList();
        const issue = db[i];
        if (!issue) {
          clearEditor();
          btnDuplicate.disabled = true;
          btnDelete.disabled = true;
          selectionHint.textContent = 'Select an issue to edit';
          updateNavButtons();
          return;
        }
        selectionHint.textContent = issue.issue_id;
        btnDuplicate.disabled = false;
        btnDelete.disabled = false;
        bindEditor(issue);
        updateNavButtons();
      }

      function updateNavButtons() {
        if (db.length === 0) {
          btnPrev.disabled = true;
          btnNext.disabled = true;
          return;
        }

        btnPrev.disabled = selectedIndex <= 0;
        btnNext.disabled = selectedIndex >= db.length - 1 || selectedIndex < 0;
      }

      function navigatePrev() {
        if (selectedIndex > 0) {
          selectIssue(selectedIndex - 1);
        }
      }

      function navigateNext() {
        if (selectedIndex < db.length - 1) {
          selectIssue(selectedIndex + 1);
        }
      }

      function clearEditor() {
        f_issue_id.value = '';
        f_category.value = '';
        f_short_description.value = '';
        // keywords: clear chips and input
        if (keywordsChips) keywordsChips.innerHTML = '';
        if (kwInput) kwInput.value = '';
        if (ticketsChips) ticketsChips.innerHTML = '';
        if (tkInput) tkInput.value = '';
        f_root_cause.value = '';
        if (f_confidence_label) f_confidence_label.textContent = '—';
        f_notes.value = '';
        stepsContainer.innerHTML = '';
        [e_category, e_short_description, e_resolution_steps, e_global].forEach(n => n.textContent = '');
        updateNavButtons();
      }

      function bindEditor(issue) {
        f_issue_id.value = issue.issue_id || '';
        f_category.value = issue.category || '';
        f_short_description.value = issue.short_description || '';
        renderKeywords(issue.keywords || []);
        renderTickets(issue.tickets || []);
        f_root_cause.value = issue.root_cause || '';
        f_confidence_label.textContent = (typeof issue.confidence === 'number' ? String(issue.confidence) : '—');
        f_notes.value = issue.notes || '';

        stepsContainer.innerHTML = '';
        (issue.resolution_steps || []).forEach((s, idx) => addStepRow(s, idx));
        renumberSteps();
      }

      function addStepRow(text = '', index = null) {
        const row = document.createElement('div');
        row.className = 'step-item';
        row.innerHTML = `
          <div class="step-num"></div>
          <input class="input step-input" value="${escapeHtml(stripStepNumber(text))}" />
          <div class="row">
            <button class="btn" title="Move up">↑</button>
            <button class="btn" title="Move down">↓</button>
            <button class="btn destructive" title="Remove">✕</button>
          </div>
        `;
        const stepInput = row.querySelector('.step-input');
        const [upBtn, downBtn, delBtn] = row.querySelectorAll('button');
        if (stepInput) {
          stepInput.addEventListener('input', () => { markDirtyFromEditor(); applyEditorToSelected(); });
        }
        upBtn.addEventListener('click', () => moveStep(row, -1));
        downBtn.addEventListener('click', () => moveStep(row, +1));
        delBtn.addEventListener('click', () => { row.remove(); markDirtyFromEditor(); renumberSteps(); applyEditorToSelected(); });
        stepsContainer.appendChild(row);
        if (index !== null) stepsContainer.insertBefore(row, stepsContainer.children[index] || null);
        renumberSteps();
      }

      function moveStep(row, delta) {
        const parent = stepsContainer;
        const idx = Array.from(parent.children).indexOf(row);
        const newIdx = idx + delta;
        if (newIdx < 0 || newIdx >= parent.children.length) return;
        parent.insertBefore(row, parent.children[delta > 0 ? newIdx + 1 : newIdx]);
        markDirtyFromEditor();
        renumberSteps();
        applyEditorToSelected();
      }

      function renumberSteps() {
        const rows = Array.from(stepsContainer.children);
        rows.forEach((row, i) => {
          const num = row.querySelector('.step-num');
          const upBtn = row.querySelector('button[title="Move up"]');
          const downBtn = row.querySelector('button[title="Move down"]');
          if (num) num.textContent = String(i + 1) + '.';
          if (upBtn) upBtn.disabled = i === 0;
          if (downBtn) downBtn.disabled = i === rows.length - 1;
        });
      }

      function stripStepNumber(text) {
        return String(text).replace(/^\s*\d+[\.)]\s*/, '');
      }

      function collectEditor() {
        const keywords = collectKeywords();
        const tickets = collectTickets();
        const steps = Array.from(stepsContainer.querySelectorAll('.step-input'))
          .map(i => i.value.trim())
          .filter(Boolean)
          .map((val, idx) => `${idx + 1}. ${val}`);
        return {
          issue_id: f_issue_id.value.trim(),
          category: f_category.value.trim(),
          short_description: f_short_description.value.trim(),
          keywords,
          root_cause: f_root_cause.value.trim(),
          resolution_steps: steps,
          confidence: db[selectedIndex] && typeof db[selectedIndex].confidence === 'number' ? db[selectedIndex].confidence : null,
          notes: f_notes.value.trim(),
          tickets
        };
      }

      function clamp(x, a, b) { return Math.max(a, Math.min(b, x)); }

      function validateIssue(issue) {
        const errs = {};
        if (!issue.category) errs.category = 'Category is required';
        if (!issue.short_description) errs.short_description = 'Short description is required';
        if (!Array.isArray(issue.resolution_steps) || issue.resolution_steps.length === 0) errs.resolution_steps = 'At least one resolution step is required';
        if (issue.confidence !== null && (isNaN(issue.confidence) || issue.confidence < 0 || issue.confidence > 1)) errs.confidence = 'Confidence must be between 0 and 1';
        return errs;
      }

      function validateDb() {
        const seen = new Set();
        const errors = [];
        for (let i = 0; i < db.length; i++) {
          const it = db[i];
          const e = validateIssue(it);
          if (Object.keys(e).length) errors.push({ index: i, id: it.issue_id, errors: e });
          if (!it.issue_id) {
            errors.push({ index: i, id: it.issue_id, errors: { issue_id: 'Missing issue_id' } });
          } else if (seen.has(it.issue_id)) {
            errors.push({ index: i, id: it.issue_id, errors: { issue_id: 'Duplicate issue_id' } });
          } else {
            seen.add(it.issue_id);
          }
        }
        return { ok: errors.length === 0, errors };
      }

      function applyEditorToSelected() {
        if (selectedIndex < 0 || !db[selectedIndex]) return;
        const updated = collectEditor();
        const errs = validateIssue(updated);
        e_category.textContent = errs.category || '';
        e_short_description.textContent = errs.short_description || '';
        e_resolution_steps.textContent = errs.resolution_steps || '';
        if (Object.keys(errs).length) {
          // keep fields but don't overwrite DB if invalid
          return;
        }
        db[selectedIndex] = { ...db[selectedIndex], ...updated };
        setDirty(true);
        renderList();
      }

      function markDirtyFromEditor() {
        if (selectedIndex < 0) return;
        setDirty(true);
      }

      function nextIssueId() {
        const nums = db.map(x => String(x.issue_id || '').match(/^ISSUE-(\d{4})$/)?.[1]).filter(Boolean).map(s => parseInt(s, 10));
        const max = nums.length ? Math.max(...nums) : 0;
        const n = max + 1;
        return `ISSUE-${String(n).padStart(4, '0')}`;
      }

      function addIssue() {
        const id = nextIssueId();
        const newIssue = {
          issue_id: id,
          category: '',
          short_description: '',
          keywords: [],
          root_cause: '',
          resolution_steps: [''],
          confidence: 1.0,
          notes: '',
          tickets: []
        };
        db.push(newIssue);
        setDirty(true);
        renderList();
        selectIssue(db.length - 1);
        updateNavButtons();
      }

      function duplicateIssue() {
        if (selectedIndex < 0) return;
        const src = db[selectedIndex];
        const copy = JSON.parse(JSON.stringify(src));
        copy.issue_id = nextIssueId();
        db.push(copy);
        setDirty(true);
        renderList();
        selectIssue(db.length - 1);
        updateNavButtons();
      }

      function deleteIssue() {
        if (selectedIndex < 0) return;
        const id = db[selectedIndex].issue_id;
        if (!confirm(`Delete ${id}?`)) return;
        db.splice(selectedIndex, 1);

        // Adjust selectedIndex after deletion
        if (selectedIndex >= db.length && db.length > 0) {
          selectedIndex = db.length - 1;
        }

        setDirty(true);
        renderList();
        if (db.length > 0) {
          selectIssue(selectedIndex);
        } else {
          clearEditor();
        }
      }

      async function openFileFS() {
        const [handle] = await window.showOpenFilePicker({
          types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }],
          excludeAcceptAllOption: false,
          multiple: false
        });
        currentFileHandle = handle;
        const file = await handle.getFile();
        const text = await file.text();
        loadJsonText(text);
        fileStatus.textContent = file.name;
        btnSave.disabled = false;
        // Do not prompt for conversations folder here. The user can link it explicitly via the toolbar button.
      }

      async function saveFileFS() {
        if (!currentFileHandle) return;
        const { ok, errors } = validateDb();
        if (!ok) {
          e_global.textContent = `Cannot save: ${errors.length} invalid entr${errors.length === 1 ? 'y' : 'ies'}.`;
          showToast(saveErr);
          return;
        }
        e_global.textContent = '';
        const writable = await currentFileHandle.createWritable();
        await writable.write(serializeDb());
        await writable.close();
        setDirty(false);
        showToast(saveOk);
      }

      async function saveAsFS() {
        if (!supportsFS) return exportDownload();
        const handle = await window.showSaveFilePicker({
          suggestedName: currentFileHandle ? (await currentFileHandle.getFile()).name : 'silo_issues_db.json',
          types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }]
        });
        const writable = await handle.createWritable();
        await writable.write(serializeDb());
        await writable.close();
        currentFileHandle = handle;
        fileStatus.textContent = (await handle.getFile()).name;
        btnSave.disabled = false;
        setDirty(false);
        showToast(saveOk);
      }

      function exportDownload() {
        const blob = new Blob([serializeDb()], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'silo_issues_db.json';
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(a.href);
        a.remove();
      }

      async function copyJson() {
        const text = serializeDb();
        try {
          await navigator.clipboard.writeText(text);
          showToast(saveOk);
        } catch (e) {
          alert('Clipboard permission denied.');
        }
      }

      function importViaInput() {
        fileInput.onchange = async () => {
          const file = fileInput.files && fileInput.files[0];
          if (!file) return;
          const text = await file.text();
          loadJsonText(text);
          fileStatus.textContent = file.name;
          currentFileHandle = null; // unknown handle in fallback mode
          btnSave.disabled = !supportsFS; // only enable if FS available and we obtain handle later
          fileInput.value = '';
        };
        fileInput.click();
      }

      function loadJsonText(text) {
        let parsed;
        try {
          parsed = JSON.parse(text);
        } catch (e) {
          e_global.textContent = 'Invalid JSON: ' + e.message;
          return;
        }
        if (!Array.isArray(parsed)) {
          e_global.textContent = 'Invalid JSON: Expected a JSON array at top level';
          return;
        }

        db = parsed;
        selectedIndex = -1;
        setDirty(false);
        e_global.textContent = '';
        renderList();
        clearEditor();
        updateNavButtons();
        if (db.length) selectIssue(0);
      }

      function newDb() {
        if (dirty && !confirm('Discard unsaved changes and create new DB?')) return;
        db = [];
        selectedIndex = -1;
        setDirty(false);
        renderList();
        clearEditor();
        updateNavButtons();
        fileStatus.textContent = 'Untitled';
        currentFileHandle = null;
        btnSave.disabled = !supportsFS;
      }

      // Wire events
      btnOpen.addEventListener('click', async () => {
        if (supportsFS) {
          try {
            await openFileFS();
          } catch (e) {
            if (e?.name !== 'AbortError') {
              e_global.textContent = 'Open failed: ' + (e?.message || String(e));
            }
          }
        } else {
          importViaInput();
        }
      });
      btnSave.addEventListener('click', async () => { try { await saveFileFS(); } catch (e) { console.error(e); showToast(saveErr); } });
      btnSaveAs.addEventListener('click', async () => { try { await saveAsFS(); } catch (e) { if (e?.name !== 'AbortError') { console.error(e); showToast(saveErr); } } });
      
      btnCopy.addEventListener('click', copyJson);
      btnNew.addEventListener('click', newDb);
      btnTheme.addEventListener('click', toggleTheme);
      convClose2.addEventListener('click', closeConversationViewer);
      convFreshdesk.addEventListener('click', () => {
        const idTxt = (convTitle.textContent || '').replace('Ticket #','').trim();
        const id = parseInt(idTxt, 10);
        if (Number.isInteger(id)) {
          window.open(`https://heysilo-help.freshdesk.com/a/tickets/${id}`, '_blank', 'noopener');
        }
      });
      btnEditJson.addEventListener('click', openJsonEditor);
      jsonCancel.addEventListener('click', closeJsonEditor);
      jsonSave.addEventListener('click', saveJsonEditor);
      if (btnReassignIds) btnReassignIds.addEventListener('click', reassignIssueIdsSequentially);
      btnLinkConversations.addEventListener('click', async () => {
        await pickConversationsDir();
      });
      btnAdd.addEventListener('click', addIssue);
      btnDuplicate.addEventListener('click', duplicateIssue);
      btnDelete.addEventListener('click', deleteIssue);
      btnAddStep.addEventListener('click', () => { addStepRow(''); markDirtyFromEditor(); applyEditorToSelected(); });
      btnPrev.addEventListener('click', navigatePrev);
      btnNext.addEventListener('click', navigateNext);

      [f_category, f_short_description, f_root_cause, f_notes].forEach(input => {
        input.addEventListener('input', () => { applyEditorToSelected(); });
      });

      // Tickets chips interactions
      tkAdd.addEventListener('click', addTicketFromInput);
      tkInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); addTicketFromInput(); }
      });

      // Keywords chips interactions
      kwAdd.addEventListener('click', addKeywordFromInput);
      kwInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); addKeywordFromInput(); }
      });

      function renderKeywords(list) {
        keywordsChips.innerHTML = '';
        (list || []).forEach(kw => {
          const chip = document.createElement('span');
          chip.className = 'chip';
          chip.innerHTML = `${escapeHtml(kw)} <button class="remove" title="Remove">×</button>`;
          chip.querySelector('.remove').addEventListener('click', () => {
            chip.remove();
            markDirtyFromEditor();
            applyEditorToSelected();
          });
          keywordsChips.appendChild(chip);
        });
      }

      function addKeywordFromInput() {
        const v = kwInput.value.trim();
        if (!v) return;
        const existing = new Set(collectKeywords().map(x => x.toLowerCase()));
        if (existing.has(v.toLowerCase())) { kwInput.value = ''; return; }
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.innerHTML = `${escapeHtml(v)} <button class="remove" title="Remove">×</button>`;
        chip.querySelector('.remove').addEventListener('click', () => {
          chip.remove();
          markDirtyFromEditor();
          applyEditorToSelected();
        });
        keywordsChips.appendChild(chip);
        kwInput.value = '';
        markDirtyFromEditor();
        applyEditorToSelected();
      }

      function collectKeywords() {
        return Array.from(keywordsChips.querySelectorAll('.chip'))
          .map(ch => ch.textContent.replace('×','').trim())
          .filter(Boolean);
      }

      function renderTickets(list) {
        ticketsChips.innerHTML = '';
        (list || []).forEach(id => {
          const chip = document.createElement('span');
          chip.className = 'chip';
          chip.innerHTML = `#${escapeHtml(String(id))} <button class="remove" title="Remove">×</button>`;
          // Clicking the chip opens the conversation viewer
          chip.addEventListener('click', (e) => {
            if (e.target && (e.target).classList && (e.target).classList.contains('remove')) return;
            openConversationViewer(Number(id));
          });
          chip.querySelector('.remove').addEventListener('click', (e) => {
            e.stopPropagation();
            chip.remove();
            markDirtyFromEditor();
            applyEditorToSelected();
          });
          ticketsChips.appendChild(chip);
        });
      }

      function addTicketFromInput() {
        const v = tkInput.value.trim();
        if (!v) return;
        const n = Number(v);
        if (!Number.isInteger(n)) { tkInput.value = ''; return; }
        const existing = new Set(collectTickets().map(x => x));
        if (existing.has(n)) { tkInput.value = ''; return; }
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.innerHTML = `#${escapeHtml(String(n))} <button class=\"remove\" title=\"Remove\">×</button>`;
        chip.addEventListener('click', (e) => {
          if (e.target && (e.target).classList && (e.target).classList.contains('remove')) return;
          openConversationViewer(n);
        });
        chip.querySelector('.remove').addEventListener('click', (e) => {
          e.stopPropagation();
          chip.remove();
          markDirtyFromEditor();
          applyEditorToSelected();
        });
        ticketsChips.appendChild(chip);
        tkInput.value = '';
        markDirtyFromEditor();
        applyEditorToSelected();
      }

      function collectTickets() {
        return Array.from(ticketsChips.querySelectorAll('.chip'))
          .map(ch => Number(ch.textContent.replace('×','').replace('#','').trim()))
          .filter(n => Number.isInteger(n));
      }

      searchInput.addEventListener('input', renderList);
      const searchClear = el('searchClear');
      if (searchClear) {
        searchClear.addEventListener('click', () => {
          searchInput.value = '';
          categoryFilter.value = '';
          renderList();
          searchInput.focus();
        });
      }
      categoryFilter.addEventListener('change', renderList);

      // Environment setup
      (function init() {
        // theme: light default, restore saved
        const savedTheme = localStorage.getItem('silo-theme');
        if (savedTheme === 'dark') {
          document.body.classList.add('theme-dark');
          btnTheme.querySelector('span').textContent = 'Dark';
        } else {
          document.body.classList.remove('theme-dark');
          btnTheme.querySelector('span').textContent = 'Light';
        }
        // Measure toolbar height to prevent content scrolling under it
        const toolbar = document.querySelector('.toolbar');
        if (toolbar) {
          const h = toolbar.getBoundingClientRect().height;
          document.documentElement.style.setProperty('--toolbar-height', `${Math.round(h)}px`);
        }
        if (!supportsFS) envStatus.classList.remove('hidden');
        btnSave.disabled = true; // until a FS handle is acquired via Open or Save As
        renderList();
        clearEditor();
      })();

      function toggleTheme() {
        const isDark = document.body.classList.toggle('theme-dark');
        localStorage.setItem('silo-theme', isDark ? 'dark' : 'light');
        btnTheme.querySelector('span').textContent = isDark ? 'Dark' : 'Light';
      }

      function openConversationViewer(ticketId) {
        convTitle.textContent = `Ticket #${ticketId}`;
        convContent.innerHTML = '<div class="hint">Loading…</div>';
        convBackdrop.style.display = 'flex';
        (async () => {
          // Preferred: if user linked the conversations directory, read via FS API
          if (conversationsDirHandle) {
            try {
              const fh = await conversationsDirHandle.getFileHandle(`${ticketId}.json`);
              const file = await fh.getFile();
              const text = await file.text();
              renderConversationJson(text);
              return;
            } catch (e) {
              // fall through to fetch attempt below
            }
          }

          // Fallback: try relative fetch (may be blocked by browser for file://)
          try {
            const res = await fetch(`../conversations/${ticketId}.json`);
            if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
            const text = await res.text();
            renderConversationJson(text);
          } catch (e) {
            const needLink = supportsDirPicker ? '<button class="btn" id="convLinkNow">Link conversations folder</button>' : '';
            convContent.innerHTML = `<div class="error" style="margin-bottom:8px;">Failed to load conversation. ${escapeHtml(e.message)}</div>${needLink}<div class="hint" style="margin-top:8px;">Tip: Click a ticket again after linking.</div>`;
            const linkBtn = document.getElementById('convLinkNow');
            if (linkBtn) {
              linkBtn.addEventListener('click', async () => {
                const ok = await pickConversationsDir();
                if (ok) openConversationViewer(ticketId);
              });
            }
          }
        })();
      }

      function closeConversationViewer() {
        convBackdrop.style.display = 'none';
        convTitle.textContent = '';
        convContent.innerHTML = '';
      }

      function openJsonEditor() {
        if (selectedIndex < 0 || !db[selectedIndex]) return;
        jsonError.textContent = '';
        // Build a clean object with the persisted fields
        const issue = db[selectedIndex];
        const safe = {
          issue_id: issue.issue_id || '',
          category: issue.category || '',
          short_description: issue.short_description || '',
          keywords: Array.isArray(issue.keywords) ? issue.keywords : [],
          root_cause: issue.root_cause || '',
          resolution_steps: Array.isArray(issue.resolution_steps) ? issue.resolution_steps : [],
          confidence: typeof issue.confidence === 'number' ? issue.confidence : null,
          notes: issue.notes || '',
          tickets: Array.isArray(issue.tickets) ? issue.tickets : []
        };
        jsonTextarea.value = JSON.stringify(safe, null, 2);
        jsonBackdrop.style.display = 'flex';
      }

      function closeJsonEditor() {
        jsonBackdrop.style.display = 'none';
        jsonTextarea.value = '';
        jsonError.textContent = '';
      }

      function saveJsonEditor() {
        if (selectedIndex < 0 || !db[selectedIndex]) return;
        jsonError.textContent = '';
        let parsed;
        try {
          parsed = JSON.parse(jsonTextarea.value);
        } catch (e) {
          jsonError.textContent = 'Invalid JSON: ' + e.message;
          return;
        }
        // Validate minimal schema
        const errs = validateIssue({
          issue_id: parsed.issue_id,
          category: parsed.category,
          short_description: parsed.short_description,
          keywords: parsed.keywords,
          root_cause: parsed.root_cause,
          resolution_steps: parsed.resolution_steps,
          confidence: parsed.confidence,
          notes: parsed.notes,
          tickets: parsed.tickets
        });
        if (Object.keys(errs).length) {
          jsonError.textContent = 'Validation failed: ' + Object.keys(errs).join(', ');
          return;
        }
        // Coerce types
        parsed.keywords = Array.isArray(parsed.keywords) ? parsed.keywords.map(String) : [];
        parsed.tickets = Array.isArray(parsed.tickets) ? parsed.tickets.map(Number).filter(n => Number.isInteger(n)) : [];
        parsed.resolution_steps = Array.isArray(parsed.resolution_steps) ? parsed.resolution_steps.map(String) : [];
        if (parsed.confidence !== null && parsed.confidence !== undefined) parsed.confidence = clamp(Number(parsed.confidence), 0, 1);

        // Apply to DB and UI
        db[selectedIndex] = { ...db[selectedIndex], ...parsed };
        setDirty(true);
        renderList();
        bindEditor(db[selectedIndex]);
        closeJsonEditor();
      }

      function reassignIssueIdsSequentially() {
        if (!Array.isArray(db) || db.length === 0) return;
        // Sort by current numeric order if possible
        const items = [...db].map((item, idx) => ({ item, idx, num: parseInt(String(item.issue_id||'').match(/\d+/)?.[0] || idx+1, 10) }));
        items.sort((a,b) => a.num - b.num || a.idx - b.idx);
        items.forEach((entry, i) => {
          entry.item.issue_id = `ISSUE-${String(i + 1).padStart(4, '0')}`;
        });
        setDirty(true);
        renderList();
        // Keep current selection by index if still valid
        if (selectedIndex >= 0 && selectedIndex < db.length) {
          selectIssue(selectedIndex);
        }
      }

      async function pickConversationsDir() {
        if (!supportsDirPicker) {
          alert('Your browser does not support selecting a folder. Use Chrome/Edge.');
          return false;
        }
        try {
          const dir = await window.showDirectoryPicker({ id: 'conversations' });
          // Optional: check for any *.json files inside
          conversationsDirHandle = dir;
          btnLinkConversations.textContent = 'Conversations linked ✓';
          btnLinkConversations.disabled = false;
          return true;
        } catch (e) {
          if (e?.name !== 'AbortError') {
            alert('Failed to link folder: ' + e.message);
          }
          return false;
        }
      }

      function renderConversationJson(text) {
        try {
          const data = JSON.parse(text);
          const msgs = Array.isArray(data.conversation) ? data.conversation : [];
          convContent.innerHTML = msgs.map(m => {
            const cls = m.speaker === 'agent' ? 'agent' : 'user';
            const txt = escapeHtml(m.text || '');
            const priv = m.private ? ' (private)' : '';
            return `<div class="msg ${cls}"><div class="hint">${m.speaker}${priv}</div><div>${txt.replace(/\n/g,'<br>')}</div></div>`;
          }).join('') || '<div class="hint">No messages.</div>';
        } catch (e) {
          convContent.innerHTML = `<div class="error">Invalid conversation JSON: ${escapeHtml(e.message)}</div>`;
        }
      }
    </script>
  </body>
  </html>


